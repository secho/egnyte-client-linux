name: Security Assessment

on:
  push:
    branches: ['*']
  pull_request:
    branches: ['*']
  workflow_dispatch:
    inputs:
      full_scan:
        description: 'Run full security scan'
        required: false
        default: 'true'

permissions:
  contents: write
  security-events: write
  pull-requests: write

jobs:
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install security scanning tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety pip-audit semgrep

      - name: Initialize Security Assessment Report
        run: |
          cat > SECURITY_ASSESSMENT.md << 'EOF'
          # Security Assessment Report

          **Generated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}
          **Triggered by:** ${{ github.event_name }}

          ---

          ## Summary

          This report contains the results of automated security scanning performed on the codebase.

          EOF

      - name: Run Bandit (Python Security Linter)
        continue-on-error: true
        run: |
          echo "" >> SECURITY_ASSESSMENT.md
          echo "## 1. Bandit - Python Security Analysis" >> SECURITY_ASSESSMENT.md
          echo "" >> SECURITY_ASSESSMENT.md
          echo "Bandit is a tool designed to find common security issues in Python code." >> SECURITY_ASSESSMENT.md
          echo "" >> SECURITY_ASSESSMENT.md
          
          # Find Python files
          if find . -name "*.py" -not -path "./.git/*" | grep -q .; then
            echo '```' >> SECURITY_ASSESSMENT.md
            bandit -r . -f txt --exclude ./.git 2>&1 | tee -a SECURITY_ASSESSMENT.md || true
            echo '```' >> SECURITY_ASSESSMENT.md
          else
            echo "> â„¹ï¸ No Python files found in the repository." >> SECURITY_ASSESSMENT.md
          fi

      - name: Run pip-audit (Dependency Vulnerability Check)
        continue-on-error: true
        run: |
          echo "" >> SECURITY_ASSESSMENT.md
          echo "## 2. pip-audit - Dependency Vulnerability Scan" >> SECURITY_ASSESSMENT.md
          echo "" >> SECURITY_ASSESSMENT.md
          echo "pip-audit checks Python dependencies for known vulnerabilities." >> SECURITY_ASSESSMENT.md
          echo "" >> SECURITY_ASSESSMENT.md
          
          if [ -f requirements.txt ]; then
            echo '```' >> SECURITY_ASSESSMENT.md
            pip-audit -r requirements.txt 2>&1 | tee -a SECURITY_ASSESSMENT.md || true
            echo '```' >> SECURITY_ASSESSMENT.md
          elif [ -f setup.py ] || [ -f pyproject.toml ]; then
            echo '```' >> SECURITY_ASSESSMENT.md
            pip-audit 2>&1 | tee -a SECURITY_ASSESSMENT.md || true
            echo '```' >> SECURITY_ASSESSMENT.md
          else
            echo "> â„¹ï¸ No requirements.txt, setup.py, or pyproject.toml found." >> SECURITY_ASSESSMENT.md
          fi

      - name: Run Safety (Additional Dependency Check)
        continue-on-error: true
        run: |
          echo "" >> SECURITY_ASSESSMENT.md
          echo "## 3. Safety - Security Vulnerability Database Check" >> SECURITY_ASSESSMENT.md
          echo "" >> SECURITY_ASSESSMENT.md
          echo "Safety checks installed packages for known security vulnerabilities." >> SECURITY_ASSESSMENT.md
          echo "" >> SECURITY_ASSESSMENT.md
          
          if [ -f requirements.txt ]; then
            echo '```' >> SECURITY_ASSESSMENT.md
            safety check -r requirements.txt --output text 2>&1 | tee -a SECURITY_ASSESSMENT.md || true
            echo '```' >> SECURITY_ASSESSMENT.md
          else
            echo "> â„¹ï¸ No requirements.txt found for safety check." >> SECURITY_ASSESSMENT.md
          fi

      - name: Run Semgrep (Static Analysis)
        continue-on-error: true
        run: |
          echo "" >> SECURITY_ASSESSMENT.md
          echo "## 4. Semgrep - Static Application Security Testing (SAST)" >> SECURITY_ASSESSMENT.md
          echo "" >> SECURITY_ASSESSMENT.md
          echo "Semgrep performs lightweight static analysis for security vulnerabilities." >> SECURITY_ASSESSMENT.md
          echo "" >> SECURITY_ASSESSMENT.md
          
          echo '```' >> SECURITY_ASSESSMENT.md
          semgrep scan --config auto --config p/security-audit --config p/secrets \
            --exclude ".git" \
            --no-git-ignore \
            --text 2>&1 | tee -a SECURITY_ASSESSMENT.md || true
          echo '```' >> SECURITY_ASSESSMENT.md

      - name: Run Trivy (Comprehensive Vulnerability Scanner)
        continue-on-error: true
        run: |
          # Install Trivy
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy
          
          echo "" >> SECURITY_ASSESSMENT.md
          echo "## 5. Trivy - Comprehensive Security Scanner" >> SECURITY_ASSESSMENT.md
          echo "" >> SECURITY_ASSESSMENT.md
          echo "Trivy scans for vulnerabilities in dependencies, containers, and IaC configurations." >> SECURITY_ASSESSMENT.md
          echo "" >> SECURITY_ASSESSMENT.md
          
          echo "### Filesystem Scan" >> SECURITY_ASSESSMENT.md
          echo '```' >> SECURITY_ASSESSMENT.md
          trivy fs --security-checks vuln,secret,config . 2>&1 | tee -a SECURITY_ASSESSMENT.md || true
          echo '```' >> SECURITY_ASSESSMENT.md

      - name: Run Gitleaks (Secret Detection)
        continue-on-error: true
        run: |
          # Install Gitleaks
          wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.0_linux_x64.tar.gz
          chmod +x gitleaks
          
          echo "" >> SECURITY_ASSESSMENT.md
          echo "## 6. Gitleaks - Secret Detection" >> SECURITY_ASSESSMENT.md
          echo "" >> SECURITY_ASSESSMENT.md
          echo "Gitleaks detects hardcoded secrets, passwords, and API keys in the codebase." >> SECURITY_ASSESSMENT.md
          echo "" >> SECURITY_ASSESSMENT.md
          
          echo '```' >> SECURITY_ASSESSMENT.md
          ./gitleaks detect --source . --no-git --verbose 2>&1 | tee -a SECURITY_ASSESSMENT.md || true
          echo '```' >> SECURITY_ASSESSMENT.md

      - name: Check for common security misconfigurations
        run: |
          echo "" >> SECURITY_ASSESSMENT.md
          echo "## 7. Security Configuration Check" >> SECURITY_ASSESSMENT.md
          echo "" >> SECURITY_ASSESSMENT.md
          
          echo "### Sensitive Files Check" >> SECURITY_ASSESSMENT.md
          echo '```' >> SECURITY_ASSESSMENT.md
          
          # Check for sensitive files that shouldn't be committed
          SENSITIVE_PATTERNS=".env .env.local .env.*.local *.pem *.key id_rsa id_dsa *.p12 *.pfx credentials.json service-account.json"
          
          found_sensitive=false
          for pattern in $SENSITIVE_PATTERNS; do
            if find . -name "$pattern" -not -path "./.git/*" 2>/dev/null | grep -q .; then
              echo "âš ï¸ Found potentially sensitive file matching: $pattern"
              find . -name "$pattern" -not -path "./.git/*" 2>/dev/null
              found_sensitive=true
            fi
          done
          
          if [ "$found_sensitive" = false ]; then
            echo "âœ… No common sensitive files detected."
          fi
          
          echo '```' >> SECURITY_ASSESSMENT.md
          
          echo "" >> SECURITY_ASSESSMENT.md
          echo "### .gitignore Security Check" >> SECURITY_ASSESSMENT.md
          echo '```' >> SECURITY_ASSESSMENT.md
          
          if [ -f .gitignore ]; then
            SECURITY_PATTERNS=(".env" "*.pem" "*.key" "*.p12" "credentials" "secrets")
            missing_patterns=()
            for pattern in "${SECURITY_PATTERNS[@]}"; do
              if ! grep -q "$pattern" .gitignore 2>/dev/null; then
                missing_patterns+=("$pattern")
              fi
            done
            
            if [ ${#missing_patterns[@]} -eq 0 ]; then
              echo "âœ… .gitignore includes common security patterns."
            else
              echo "âš ï¸ Consider adding these patterns to .gitignore:"
              for p in "${missing_patterns[@]}"; do
                echo "  - $p"
              done
            fi
          else
            echo "âš ï¸ No .gitignore file found. Consider creating one with security-sensitive patterns."
          fi
          
          echo '```' >> SECURITY_ASSESSMENT.md

      - name: Generate Summary Statistics
        run: |
          echo "" >> SECURITY_ASSESSMENT.md
          echo "---" >> SECURITY_ASSESSMENT.md
          echo "" >> SECURITY_ASSESSMENT.md
          echo "## Assessment Summary" >> SECURITY_ASSESSMENT.md
          echo "" >> SECURITY_ASSESSMENT.md
          echo "| Scanner | Status |" >> SECURITY_ASSESSMENT.md
          echo "|---------|--------|" >> SECURITY_ASSESSMENT.md
          echo "| Bandit (Python SAST) | Completed |" >> SECURITY_ASSESSMENT.md
          echo "| pip-audit (Dependencies) | Completed |" >> SECURITY_ASSESSMENT.md
          echo "| Safety (Vulnerability DB) | Completed |" >> SECURITY_ASSESSMENT.md
          echo "| Semgrep (SAST) | Completed |" >> SECURITY_ASSESSMENT.md
          echo "| Trivy (Comprehensive) | Completed |" >> SECURITY_ASSESSMENT.md
          echo "| Gitleaks (Secrets) | Completed |" >> SECURITY_ASSESSMENT.md
          echo "| Config Check | Completed |" >> SECURITY_ASSESSMENT.md
          echo "" >> SECURITY_ASSESSMENT.md
          echo "---" >> SECURITY_ASSESSMENT.md
          echo "" >> SECURITY_ASSESSMENT.md
          echo "*This report was automatically generated by the Security Assessment workflow.*" >> SECURITY_ASSESSMENT.md
          echo "" >> SECURITY_ASSESSMENT.md
          echo "**Recommendations:**" >> SECURITY_ASSESSMENT.md
          echo "1. Review all HIGH and CRITICAL findings immediately" >> SECURITY_ASSESSMENT.md
          echo "2. Address MEDIUM findings in the next sprint" >> SECURITY_ASSESSMENT.md
          echo "3. Track LOW findings for future improvement" >> SECURITY_ASSESSMENT.md
          echo "4. Re-run scans after fixes to verify remediation" >> SECURITY_ASSESSMENT.md

      - name: Upload Security Assessment as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: security-assessment
          path: SECURITY_ASSESSMENT.md
          retention-days: 90

      - name: Commit Security Assessment
        if: github.event_name == 'push'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Check if there are changes to commit
          if git diff --quiet SECURITY_ASSESSMENT.md 2>/dev/null; then
            echo "No changes to SECURITY_ASSESSMENT.md"
          else
            git add SECURITY_ASSESSMENT.md
            git commit -m "chore: update security assessment report [skip ci]

            Automated security scan results for commit ${{ github.sha }}"
            git push
          fi

      - name: Comment on PR with Summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('SECURITY_ASSESSMENT.md', 'utf8');
            
            // Extract summary section
            const summaryStart = report.indexOf('## Assessment Summary');
            const summary = summaryStart !== -1 ? report.substring(summaryStart) : 'Security scan completed. See artifacts for full report.';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ”’ Security Assessment Results\n\n${summary}\n\n*Full report available in workflow artifacts.*`
            });
